<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Cube - WebXR</title>
    <style>
      body { margin: 0; overflow: hidden; }
      canvas { display: block; }
    </style>
    <!-- Three.js & WebXR support -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/WebXR/VRButton.js"></script>
  </head>
  <body>
    <script>
      let scene, camera, renderer, cube;

      // Initialize
      function init() {
        scene = new THREE.Scene();

        // Camera for AR mode
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

        // Transparent AR renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // WebXR AR Button
        document.body.appendChild(VRButton.createButton(renderer, {
          requiredFeatures: ['hit-test'],
          optionalFeatures: ['dom-overlay'],
          domOverlay: { root: document.body }
        }));

        // Lighting
        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        light.position.set(0.5, 1, 0.25);
        scene.add(light);

        // Cube
        const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        cube = new THREE.Mesh(geometry, material);
        cube.visible = false; // Will show only after hit test
        scene.add(cube);

        setupARHitTest();
      }

      // Hit test (surface placement)
      function setupARHitTest() {
        let hitTestSource = null;
        let localSpace = null;

        renderer.xr.addEventListener('sessionstart', async () => {
          const session = renderer.xr.getSession();
          const viewerSpace = await session.requestReferenceSpace('viewer');
          localSpace = await session.requestReferenceSpace('local');
          hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

          renderer.setAnimationLoop((timestamp, frame) => {
            if (!frame) return;

            const refSpace = localSpace;
            const hitTestResults = frame.getHitTestResults(hitTestSource);

            if (hitTestResults.length > 0) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(refSpace);

              cube.visible = true;
              cube.position.set(
                pose.transform.position.x,
                pose.transform.position.y,
                pose.transform.position.z
              );
              cube.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
          });
        });
      }

      init();
    </script>
  </body>
</html>
